<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Node1-基础 | LuckNora</title><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="node 基础概述架构 Natives modules  内置核心模块   当前层内容由 js 实现 提供应用程序可直接调用库，如 fs path http 等 js 语言无法直接操作底层硬件设置  Bindings 胶水层  V8 引擎配合实现  如 socket，本身并不是代码级别的功能实现，而是一个功能对照表 底层  V8：执行 JS 代码、提供桥梁接口 libuv 库：时间循环、事件队列、">
<meta property="og:type" content="article">
<meta property="og:title" content="Node1-基础">
<meta property="og:url" content="http://example.com/2023/05/17/%E5%89%8D%E7%AB%AF/node/1.node%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="LuckNora">
<meta property="og:description" content="node 基础概述架构 Natives modules  内置核心模块   当前层内容由 js 实现 提供应用程序可直接调用库，如 fs path http 等 js 语言无法直接操作底层硬件设置  Bindings 胶水层  V8 引擎配合实现  如 socket，本身并不是代码级别的功能实现，而是一个功能对照表 底层  V8：执行 JS 代码、提供桥梁接口 libuv 库：时间循环、事件队列、">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2023/06/21/vrZHaQkuVwFMXJq.jpg">
<meta property="article:published_time" content="2023-05-17T06:15:43.000Z">
<meta property="article:modified_time" content="2023-07-05T09:06:08.562Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="前端">
<meta property="article:tag" content="node">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/21/vrZHaQkuVwFMXJq.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/17/%E5%89%8D%E7%AB%AF/node/1.node%E5%9F%BA%E7%A1%80/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Node1-基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-05 17:06:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic3.zhimg.com/80/v2-a32e894df08df50d7a3674b64fec74f2_1440w.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-video"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('https://s2.loli.net/2023/06/21/vrZHaQkuVwFMXJq.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="LuckNora"><span class="site-name">LuckNora</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-video"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Node1-基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-05-17T06:15:43.000Z" title="Created 2023-05-17 14:15:43">2023-05-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-07-05T09:06:08.562Z" title="Updated 2023-07-05 17:06:08">2023-07-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Node1-基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="node-基础"><a href="#node-基础" class="headerlink" title="node 基础"></a>node 基础</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="https://s2.loli.net/2023/06/12/QX7A1TwKHha39C5.png" alt="image-20230612112241214"></p>
<p><strong><em>Natives modules</em></strong></p>
<blockquote>
<p>内置核心模块</p>
</blockquote>
<ul>
<li>当前层内容由 js 实现</li>
<li>提供应用程序可直接调用库，如 fs path http 等</li>
<li>js 语言无法直接操作底层硬件设置</li>
</ul>
<p><strong><em>Bindings 胶水层</em></strong></p>
<blockquote>
<p>V8 引擎配合实现</p>
</blockquote>
<p>如 socket，本身并不是代码级别的功能实现，而是一个功能对照表</p>
<p><strong><em>底层</em></strong></p>
<ul>
<li>V8：执行 JS 代码、提供桥梁接口</li>
<li>libuv 库：时间循环、事件队列、异步 IO</li>
<li>第三方模块：zlib&#x2F;http&#x2F;c-ares 等</li>
</ul>
<h3 id="Node-IO-过程"><a href="#Node-IO-过程" class="headerlink" title="Node IO 过程"></a>Node IO 过程</h3><p><img src="https://s2.loli.net/2023/06/12/tCqmJQfx4AOvDpX.png" alt="image-20230612135140160"></p>
<ul>
<li>IO 是应用程序的瓶颈所在</li>
<li>异步 IO 提供性能无需原地等待结果返回</li>
<li>IO 操作属于操作系统级别，平台都有对应的实现</li>
<li>Nodejs 单线程配合事件驱动架构及 libuv 实现异步 IO</li>
</ul>
<h3 id="Node-事件驱动"><a href="#Node-事件驱动" class="headerlink" title="Node 事件驱动"></a>Node 事件驱动</h3><blockquote>
<p>对比：事件驱动、发布订阅、观察者</p>
<p>共同特点：主体发布消息，其他实例接收消息</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node事件驱动代码举例</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myEvent = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>()</span><br><span class="line"></span><br><span class="line">myEvent.<span class="title function_">on</span>(<span class="string">&#x27;事件1&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;事件1执行了&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">myEvent.<span class="title function_">on</span>(<span class="string">&#x27;事件1&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;事件1-2执行了&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">myEvent.<span class="title function_">emit</span>(<span class="string">&#x27;事件1&#x27;</span>)</span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="comment">// 事件1执行了</span></span><br><span class="line"><span class="comment">// 事件1-2执行了</span></span><br></pre></td></tr></table></figure>

<h3 id="Nodejs-单线程"><a href="#Nodejs-单线程" class="headerlink" title="Nodejs 单线程"></a>Nodejs 单线程</h3><blockquote>
<p>Nodejs 主线程是单线程</p>
<p>libuv 库中存在一个线程池，默认有 4 个线程</p>
<p>异步操作被分为：网络 IO、非网络 IO、非 IO</p>
</blockquote>
<ul>
<li>Nodejs 虽然是单线程的机制，但是配合异步 IO 和事件循环，就可以去实现高并发请求</li>
<li>Node 的单线程指的是运行 JS 代码的主线程是单线程，也就是 V8 引擎中专门执行 js 代码的那部分，但是在 libuv 库中是存在着一个线程池</li>
<li>Nodejs 的单线程也决定了其不适合去处理 CPU 密集型任务（比如计算）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> sleep = <span class="title class_">Date</span>.<span class="title function_">now</span>() + time * <span class="number">1000</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() &lt; sleep) &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server starting&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">sleep</span>(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8080</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;服务启动了&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Nodejs-常见的应用场景"><a href="#Nodejs-常见的应用场景" class="headerlink" title="Nodejs 常见的应用场景"></a>Nodejs 常见的应用场景</h3><ul>
<li>io 密集型的高并发请求（非阻塞的异步 io 操作）</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/12/igjT31hNx8rKcZQ.png" alt="image-20230612145824304"></p>
<ul>
<li>操作数据库 提供 API 服务</li>
<li>实现聊天应用程序</li>
</ul>
<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><blockquote>
<p>全局对象是 js 中的特殊对象</p>
<p>nodejs 中的全局对象和浏览器平台的 window 不完全相同</p>
<p>nodejs 的全局对象挂载了许多属性</p>
</blockquote>
<p><strong><em>Nodejs 中的全局对象是 global（根本作用就是作为全局变量的宿主）</em></strong></p>
<ul>
<li>__filename: 返回正在执行脚本文件的绝对路径</li>
<li>__dirname: 返回正在执行脚本所在目录</li>
<li>time 类函数：执行顺序与事件循环间的关系</li>
<li>process: 提供与当前进程互动的接口</li>
<li>require: 实现模块的加载</li>
<li>module&#x2F;exports: 处理模块的导出</li>
</ul>
<p><strong>每个模块内部都是独立的空间，实现：每个模块中的内容都被放在了一个自调用的函数中</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>) <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span> === <span class="variable language_">global</span>)(</span><br><span class="line">  <span class="comment">// false</span></span><br><span class="line">  <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span> === <span class="variable language_">global</span>) <span class="comment">// true</span></span><br><span class="line">  &#125;</span><br><span class="line">)()</span><br></pre></td></tr></table></figure>

<h3 id="process"><a href="#process" class="headerlink" title="process"></a>process</h3><ul>
<li><p>获取进程信息</p>
<p>获取当前正在执行的脚本信息–得到对 cpu 和内存消耗的数据，获取本地环境</p>
</li>
<li><p>执行进程操作</p>
<p>监听进程在执行的过程中存在的一些事件，创建子进程，让两者进行通信</p>
</li>
</ul>
<h4 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h4><p><strong>资源信息</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">memoryUsage</span>()) <span class="comment">// 获取内存的信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">cpuUsage</span>()) <span class="comment">// 获取cpu占用信息</span></span><br></pre></td></tr></table></figure>

<p><strong>运行环境</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行环境、运行目录、node环境、cpu架构、用户环境、系统平台</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">cwd</span>()) <span class="comment">// cwd current work directory 当前工作路径</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">version</span>) <span class="comment">// node版本</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">versions</span>) <span class="comment">// node v8 uv等</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">arch</span>) <span class="comment">// cpu架构</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>.<span class="property">NODE_ENV</span>) <span class="comment">// 用户环境 区分生产环境还是开发环境</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>.<span class="property">PATH</span>) <span class="comment">// 本机配置的环境变量</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>.<span class="property">HOME</span>) <span class="comment">// 本机管理员目录windows:PLATFORM mac:HOME</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">platform</span>) <span class="comment">// 平台</span></span><br></pre></td></tr></table></figure>

<p><strong>运行状态</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行状态：启动参数、PID、运行时间</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">argv</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">pid</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">uptime</span>()) <span class="comment">// 当前脚本运行时间</span></span><br></pre></td></tr></table></figure>

<h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内部只能写入同步代码</span></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;exit&#x27;</span> + code)</span><br><span class="line">&#125;)</span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;beforeExit&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;beforeExit&#x27;</span> + code)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 了解</span></span><br><span class="line"><span class="comment">// stdout标准输出  流</span></span><br><span class="line"><span class="comment">// console.log = function (data) &#123;</span></span><br><span class="line"><span class="comment">//   process.stdout.write(&#x27;--&#x27; + data + &#x27;\n&#x27;)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// console.log(11)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const fs = require(&#x27;fs&#x27;)</span></span><br><span class="line"><span class="comment">// fs.createReadStream(&#x27;test.txt&#x27;).pipe(process.stdout)</span></span><br><span class="line"></span><br><span class="line">process.<span class="property">stdin</span>.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">process.<span class="property">stdin</span>.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// chunk 代码块</span></span><br><span class="line">  <span class="keyword">let</span> chunk = process.<span class="property">stdin</span>.<span class="title function_">read</span>()</span><br><span class="line">  <span class="keyword">if</span> (chunk !== <span class="literal">null</span>) &#123;</span><br><span class="line">    process.<span class="property">stdout</span>.<span class="title function_">write</span>(<span class="string">&#x27;data&#x27;</span> + chunk)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="核心模块"><a href="#核心模块" class="headerlink" title="核心模块"></a>核心模块</h2><h3 id="path"><a href="#path" class="headerlink" title="path"></a>path</h3><blockquote>
<p>用于处理文件&#x2F;目录的路径</p>
</blockquote>
<ul>
<li>basename() 获取路径中的基础名称</li>
<li>dirname() 获取路径中的目录名称</li>
<li>extname() 获取路径中的扩展名称</li>
<li>isAbsolute() 获取路径是否为绝对路径</li>
<li>join() 拼接多个路径片段</li>
<li>resolve() 返回绝对路径</li>
<li>parse() 解析路径</li>
<li>format() 序列化路径</li>
<li>normalize() 规范化路径</li>
</ul>
<p><strong>1.basename</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取路径中的基础名称</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__filename) <span class="comment">// /Users/xxx/Desktop/lagou-node/06_path.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">basename</span>(__filename)) <span class="comment">// 06_path.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">basename</span>(__filename, <span class="string">&#x27;.js&#x27;</span>)) <span class="comment">// 06_path</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">basename</span>(<span class="string">&#x27;/a/b/c&#x27;</span>)) <span class="comment">// c</span></span><br></pre></td></tr></table></figure>

<p><strong>2.dirname</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.2 获取路径目录名</span></span><br><span class="line"><span class="comment">// 返回路径中最后一部分的上一层目录所在路径</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">dirname</span>(__filename)) <span class="comment">// /Users/xxx/Desktop/lagou-node</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">dirname</span>(<span class="string">&#x27;/a/b/c&#x27;</span>)) <span class="comment">// /a/b</span></span><br></pre></td></tr></table></figure>

<p><strong>3.extname</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.3获取路径扩展名</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">extname</span>(__filename)) <span class="comment">// .js</span></span><br></pre></td></tr></table></figure>

<p><strong>4.parse</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = path.<span class="title function_">parse</span>(<span class="string">&#x27;/a/b/c/index.html&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj)</span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   root: &#x27;/&#x27;,</span></span><br><span class="line"><span class="comment">//   dir: &#x27;/a/b/c&#x27;,</span></span><br><span class="line"><span class="comment">//   base: &#x27;index.html&#x27;,</span></span><br><span class="line"><span class="comment">//   ext: &#x27;.html&#x27;,</span></span><br><span class="line"><span class="comment">//   name: &#x27;index&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>5.format</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.5 序列化路径 path.parse的反向操作</span></span><br><span class="line"><span class="keyword">const</span> obj2 = path.<span class="title function_">parse</span>(<span class="string">&#x27;/a/b/c/index.html&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">format</span>(obj2)) <span class="comment">// /a/b/c/index.html</span></span><br></pre></td></tr></table></figure>

<p><strong>6.isAbsolute</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.6 判断当前路径是否为绝对路径</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">isAbsolute</span>(<span class="string">&#x27;foo&#x27;</span>)) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">isAbsolute</span>(<span class="string">&#x27;/foo&#x27;</span>)) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p><strong>7.join</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.7 拼接路径</span></span><br><span class="line"><span class="comment">// 通过一个函数接收多个路径片段，从后往前进行拼接</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;a/b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>)) <span class="comment">// a/b/c/index.html</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;a/b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;../&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>)) <span class="comment">// a/b/index.html</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;a/b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>)) <span class="comment">// a/b/c/index.html</span></span><br></pre></td></tr></table></figure>

<p><strong>8.normalize</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.8 规范化路径</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">normalize</span>(<span class="string">&#x27;a/b/c/d&#x27;</span>)) <span class="comment">// a/b/c/d</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">normalize</span>(<span class="string">&#x27;a///b/c../d&#x27;</span>)) <span class="comment">// a/b/c../d</span></span><br><span class="line"><span class="comment">// console.log(path.normalize(&#x27;a//\\b/c\\/d&#x27;)) // a/\b/c\/d</span></span><br></pre></td></tr></table></figure>

<p><strong>9.resolve</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.9 绝对路径</span></span><br><span class="line"><span class="comment">// resolve([from], to)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>()) <span class="comment">// /Users/xxx/Desktop/lagou-node</span></span><br><span class="line"><span class="comment">// 如果这样传 a和b都是to的部分 会看一下a b是不是绝对路径 不是的话 会把cwd加上去</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>)) <span class="comment">// /Users/xxx/Desktop/lagou-node/a/b</span></span><br><span class="line"><span class="comment">// 如果这样传  a就是from 返回的就是 /b</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;/b&#x27;</span>)) <span class="comment">// /b</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;/a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>)) <span class="comment">// /a/b</span></span><br><span class="line"><span class="comment">// 实际开发中最常用的写法</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;index.html&#x27;</span>)) <span class="comment">// /Users/xxx/Desktop/lagou-node/index.html</span></span><br></pre></td></tr></table></figure>

<h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h3><blockquote>
<ul>
<li><p>1.无需 require 的一个全局变量</p>
</li>
<li><p>2.实现 Nodejs 平台的二进制数据操作</p>
</li>
<li><p>3.node 中的 Buffer 是一片内存空间，不占据 V8 堆内存</p>
</li>
<li><p>4.内存的使用由 node 来控制，由 V8 的 GC 回收</p>
</li>
<li><p>5.一般配合 Stream 流使用，充当数据缓冲区</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>IO 行为操作的就是二进制数据</p>
</li>
<li><p>Stream 流可以理解为一种数据类型，可以存储数据，但是可以分段</p>
</li>
<li><p>流操作配合管道实现数据分段传输</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>数据的端到端传输会有生产者和消费者</li>
<li>生产和消费的过程往往存在等待</li>
<li>产生等待时数据存放在哪里（等待时多出来的数据，或不够一次消费的数据）</li>
</ul>
</blockquote>
<h4 id="创建-Buffer-实例"><a href="#创建-Buffer-实例" class="headerlink" title="创建 Buffer 实例"></a>创建 Buffer 实例</h4><blockquote>
<p>alloc &#x2F;allocUnsafe &#x2F;from</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> b1 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">const</span> b2 = <span class="title class_">Buffer</span>.<span class="title function_">allocUnsafe</span>(<span class="number">10</span>) <span class="comment">// 不安全的 里面会有一些数据 可能是别人的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二个参数 默认是utf8</span></span><br><span class="line"><span class="keyword">const</span> b3 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="comment">// console.log(b3)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b4 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b5 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;中&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b5) <span class="comment">// &lt;Buffer e4 b8 ad&gt; 汉字在utf8中占用三个字节</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b5.<span class="title function_">toString</span>()) <span class="comment">// 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接传入汉字的16进制，通过toString() 可以得到汉字</span></span><br><span class="line"><span class="keyword">const</span> b6 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>([<span class="number">0xe4</span>, <span class="number">0xb8</span>, <span class="number">0xad</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b6.<span class="title function_">toString</span>()) <span class="comment">// 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于buffer的操作和数组很类似，有长度，也可以通过下标操作</span></span><br><span class="line"><span class="comment">// b7 b8是否是同一块内存？</span></span><br><span class="line"><span class="keyword">const</span> b7 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">const</span> b8 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(b7)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b7) <span class="comment">// &lt;Buffer 00 00 00&gt;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b8) <span class="comment">// &lt;Buffer 00 00 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 结论：并不是同一块空间</span></span><br><span class="line">b7[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b7) <span class="comment">// &lt;Buffer 01 00 00&gt;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b8) <span class="comment">// &lt;Buffer 00 00 00&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Buffer-实例方法"><a href="#Buffer-实例方法" class="headerlink" title="Buffer 实例方法"></a>Buffer 实例方法</h4><blockquote>
<p>fill &#x2F;write &#x2F;toString &#x2F;slice &#x2F;indexOf &#x2F;copy</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">6</span>)</span><br><span class="line"><span class="comment">// 1.fill 如果只有一个参数 则会完全填满buf，如果长度不够就复制</span></span><br><span class="line"><span class="comment">// 后面两个参数是位置 表示填充1-3的位置 顾头不顾尾，只会填充1,2</span></span><br><span class="line">buf.<span class="title function_">fill</span>(<span class="string">&#x27;123&#x27;</span>, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.write长度不够不会复制重复写入，第2个参数是写入位置，第3个参数是写入长度</span></span><br><span class="line">buf.<span class="title function_">write</span>(<span class="string">&#x27;123&#x27;</span>, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.toString 后面两个参数是位置 顾头不顾尾</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;百度阿里&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf.<span class="title function_">toString</span>()) <span class="comment">// 百度阿里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.slice Buffer&#x27; of &#x27;buf.slice&#x27; is deprecated.</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;百度阿里&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> b1 = buf.<span class="title function_">slice</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.indexOf</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;im mike in shanghai&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf.<span class="title function_">indexOf</span>(<span class="string">&#x27;i&#x27;</span>)) <span class="comment">// 0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf.<span class="title function_">indexOf</span>(<span class="string">&#x27;p&#x27;</span>)) <span class="comment">// -1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.copy b2拷贝源  b1拷贝容器</span></span><br><span class="line"><span class="keyword">let</span> b1 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">6</span>)</span><br><span class="line"><span class="keyword">let</span> b2 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;上海&#x27;</span>)</span><br><span class="line">b2.<span class="title function_">copy</span>(b1)</span><br></pre></td></tr></table></figure>

<h4 id="Buffer-静态方法"><a href="#Buffer-静态方法" class="headerlink" title="Buffer 静态方法"></a>Buffer 静态方法</h4><blockquote>
<p>concat &#x2F; isBuffer</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.concat</span></span><br><span class="line"><span class="keyword">let</span> b1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;上海&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> b2 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;深圳&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([b1, b2])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b.<span class="title function_">toString</span>()) <span class="comment">// 上海深圳</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.isBuffer</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(b)) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="fs"><a href="#fs" class="headerlink" title="fs"></a>fs</h3><blockquote>
<p>buffer 和 stream 一个是缓冲区 一个是数据流</p>
<p>在 node 中 fs 是内置的核心模块，提供文件操作的 api</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/13/Sixp7YQo4P6LODf.png" alt="image-20230613154346677"></p>
<h4 id="fs-基本知识"><a href="#fs-基本知识" class="headerlink" title="fs 基本知识"></a>fs 基本知识</h4><p><strong>1.用户对于文件所具备的操作权限</strong></p>
<blockquote>
<p>R- 读权限 W-写权限 X-执行权限</p>
<p>八进制数字分别对应 4 2 1 不具备权限则为 0</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/13/2dCqcfYPFV4TjUB.png" alt="image-20230613154815482"></p>
<p><strong>2.常见 flag 操作符</strong></p>
<blockquote>
<p>r: 可读 、 w：可写、s：表示同步、+：表示执行相反操作、x：表示排它操作 、a：表示追加操作</p>
</blockquote>
<p><strong>3.fd</strong></p>
<blockquote>
<p>fd 就是操作系统分配给被打开文件的标识</p>
</blockquote>
<h4 id="文件操作-API"><a href="#文件操作-API" class="headerlink" title="文件操作 API"></a>文件操作 API</h4><blockquote>
<p>readFIle &#x2F; writeFile &#x2F; appendFile &#x2F; copyFile &#x2F; watchFile</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.readFile</span></span><br><span class="line"><span class="comment">// node中有错误优先的概念</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;data.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err) <span class="comment">// null</span></span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 百度阿里</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.writeFile 会覆盖文件中的内容，如果不存在就会创建文件</span></span><br><span class="line">fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;hello node.js&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    fs.<span class="title function_">readFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// hello node.js</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">writeFile</span>(</span><br><span class="line">  <span class="string">&#x27;data.txt&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">mode</span>: <span class="number">438</span>,</span><br><span class="line">    <span class="attr">flag</span>: <span class="string">&#x27;r+&#x27;</span>, <span class="comment">// r+不会直接覆盖 w+会直接覆盖</span></span><br><span class="line">    <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">      fs.<span class="title function_">readFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123lo node.js</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.appendFile 在内容尾部追加新内容</span></span><br><span class="line">fs.<span class="title function_">appendFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;百度阿里&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入成功&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4.copyFile</span></span><br><span class="line">fs.<span class="title function_">copyFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;data_copy.txt&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拷贝成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.watchFile</span></span><br><span class="line">fs.<span class="title function_">watchFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, &#123; <span class="attr">interval</span>: <span class="number">20</span> &#125;, <span class="function">(<span class="params">curr, prev</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 判断当前文件是否被修改 mtime 就是modifiedTime</span></span><br><span class="line">  <span class="keyword">if</span> (curr.<span class="property">mtime</span> !== prev.<span class="property">mtime</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件被修改了&#x27;</span>)</span><br><span class="line">    <span class="comment">// 取消监控</span></span><br><span class="line">    fs.<span class="title function_">unwatchFile</span>(<span class="string">&#x27;data.txt&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>文件打开与关闭</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件的打开与关闭</span></span><br><span class="line"><span class="comment">// readFile和 writeFile是将文件所有内容一次性读取或者写入到内存里，这种方式对于大体积文件不合理，</span></span><br><span class="line"><span class="comment">// 因此后面需要边读边写 、 边写边读，将打开 编写 关闭 分成独立的操作</span></span><br><span class="line">fs.<span class="title function_">open</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, fd</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(fd)</span><br><span class="line">  fs.<span class="title function_">close</span>(fd, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;关闭成功&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="大文件读写复制"><a href="#大文件读写复制" class="headerlink" title="大文件读写复制"></a>大文件读写复制</h4><p><strong>先打开再读取</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.read(rfd, buf, offset, length, 磁盘文件内容从positon位置开始读取 (err, readBytes, data))</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// read: 所谓的读操作 就是将数据从磁盘文件中写入到buffer中</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">open</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, rfd</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// rfd 定位当前被打开的文件</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(rfd)</span><br><span class="line">  fs.<span class="title function_">read</span>(rfd, buf, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="function">(<span class="params">err, readBytes, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(readBytes)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>先打开再写入</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写操作就是将缓冲区的内容写入到磁盘中</span></span><br><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;12345678&#x27;</span>)</span><br><span class="line">fs.<span class="title function_">open</span>(<span class="string">&#x27;b.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="function">(<span class="params">err, wfd</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(wfd)</span><br><span class="line">  fs.<span class="title function_">write</span>(wfd, buf, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="function">(<span class="params">err, written, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(written)</span><br><span class="line">    fs.<span class="title function_">close</span>(wfd)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>复制大文件</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BUFFER_SIZE</span> = buf.<span class="property">length</span></span><br><span class="line"><span class="keyword">let</span> readOffset = <span class="number">0</span></span><br><span class="line">fs.<span class="title function_">open</span>(<span class="string">&#x27;a.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, rfd</span>) =&gt;</span> &#123;</span><br><span class="line">  fs.<span class="title function_">open</span>(<span class="string">&#x27;b.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="function">(<span class="params">err, wfd</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">      fs.<span class="title function_">read</span>(rfd, buf, <span class="number">0</span>, <span class="variable constant_">BUFFER_SIZE</span>, readOffset, <span class="function">(<span class="params">err, readBytes</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!readBytes) &#123;</span><br><span class="line">          <span class="comment">// 如果条件成立，说明内容已经读取完毕</span></span><br><span class="line">          fs.<span class="title function_">close</span>(rfd, <span class="function">() =&gt;</span> &#123;&#125;)</span><br><span class="line">          fs.<span class="title function_">close</span>(wfd, <span class="function">() =&gt;</span> &#123;&#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拷贝完成&#x27;</span>)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        readOffset += readBytes</span><br><span class="line">        fs.<span class="title function_">write</span>(wfd, buf, <span class="number">0</span>, readBytes, <span class="function">(<span class="params">err, written</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">next</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h4><ul>
<li>access: 判断文件或目录是否具有操作权限</li>
<li>stat: 获取目录及文件信息</li>
<li>mkdir: 创建目录</li>
<li>rmdir: 删除目录</li>
<li>readdir：读取目录中内容</li>
<li>unlink: 删除指定文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.access</span></span><br><span class="line">fs.<span class="title function_">access</span>(<span class="string">&#x27;a.txt&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有操作权限&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.stat</span></span><br><span class="line">fs.<span class="title function_">stat</span>(<span class="string">&#x27;a.txt&#x27;</span>, <span class="function">(<span class="params">err, statObj</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(statObj.<span class="property">size</span>) <span class="comment">// 17</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(statObj.<span class="title function_">isFile</span>()) <span class="comment">// true</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(statObj.<span class="title function_">isDirectory</span>()) <span class="comment">// false</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.mkdir</span></span><br><span class="line"><span class="comment">// &#123; recursive: true &#125;递归的 可以直接创建多层目录</span></span><br><span class="line"><span class="comment">// 如果不加这个属性 则必须保证最后一个目录之前的目录都存在</span></span><br><span class="line">fs.<span class="title function_">mkdir</span>(<span class="string">&#x27;a/b/c&#x27;</span>, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;创建成功&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4.rmdir</span></span><br><span class="line"><span class="comment">// a/b/c默认只会删除最后一个c（删除的只是basename的）</span></span><br><span class="line"><span class="comment">// 如果想要删除多层级的目录，应该传入最外层a</span></span><br><span class="line"><span class="comment">// 默认情况下只能删除空目录</span></span><br><span class="line"><span class="comment">// &#123; recursive: true &#125;添加该属性，有文件也可以删除</span></span><br><span class="line">fs.<span class="title function_">rmdir</span>(<span class="string">&#x27;a&#x27;</span>, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除成功&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除失败&#x27;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.readdir</span></span><br><span class="line"><span class="comment">// 只能得到当前文件夹下的子文件  不会递归</span></span><br><span class="line">fs.<span class="title function_">readdir</span>(<span class="string">&#x27;a&#x27;</span>, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(files) <span class="comment">// [ &#x27;a.txt&#x27;, &#x27;b&#x27; ]</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6.unlink 删除文件</span></span><br><span class="line">fs.<span class="title function_">unlink</span>(<span class="string">&#x27;a/a.txt&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除成功&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><blockquote>
<p>node 中的流就是处理流式数据的抽象接口</p>
</blockquote>
<h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p><strong>1.为什么要使用流？</strong></p>
<ul>
<li>同步读取资源文件，用户需要等待数据读取完成</li>
<li>资源文件最终一次性加载至内存，开销较大</li>
</ul>
<p><strong>2.流处理数据的优势</strong></p>
<ul>
<li>时间效率：流的分段处理可以同时操作多个数据的 chunk</li>
<li>空间效率：同一时间流无需占据大内存空间</li>
<li>使用方便：流配合管理，扩展程序变得简单</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/16/irPgpBTvD5a64zm.png" alt="image-20230616141022023"></p>
<p><strong>3.node 中流的分类</strong></p>
<p><img src="https://s2.loli.net/2023/06/16/yrbFH3KCUcjNkuf.png" alt="image-20230616141835160"></p>
<p><strong>4.node 中流的特点</strong></p>
<p><img src="https://s2.loli.net/2023/06/16/eRwYvQT2Ds6jSZm.png" alt="image-20230616144020386"></p>
<h4 id="可读流"><a href="#可读流" class="headerlink" title="可读流"></a>可读流</h4><blockquote>
<p>可读流相等于一个数据源，专门用来生产数据</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;a.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">pipe</span>(process.<span class="property">stdout</span>)</span><br></pre></td></tr></table></figure>

<p><strong>自定义可读流</strong></p>
<ul>
<li>继承 stream 里的 Readable</li>
<li>重写_read 方法调用 push 产出数据</li>
</ul>
<p><strong>自定义可读流问题</strong></p>
<ul>
<li><p>底层数据读取完成之后如何处理？</p>
<blockquote>
<p>在底层数据完成之后，可以给 Push 传递一个 Null 值</p>
</blockquote>
</li>
<li><p>消费者如何获取可读流中的数据？</p>
<blockquote>
<p>readable 事件 和 data 事件</p>
</blockquote>
</li>
</ul>
<p><strong>两种模式：流动模式、暂停模式</strong></p>
<blockquote>
<p>有时按需得读取一定量的数据，有时需要把底层数据全部读出</p>
<p>对使用者而言的区别：是否需要主动调用 read 方法来读取数据</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/16/ThvIVlpwyaGCD9H.png" alt="image-20230616152515351"></p>
<p><img src="https://s2.loli.net/2023/06/16/KjF91xv87IJpiwn.png" alt="image-20230616152717095"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Readable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟底层数据</span></span><br><span class="line"><span class="keyword">let</span> source = [<span class="string">&#x27;lg&#x27;</span>, <span class="string">&#x27;zec&#x27;</span>, <span class="string">&#x27;zyy&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义类继承Readable</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyReadable</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Readable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">source</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">source</span> = source</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_read</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="variable language_">this</span>.<span class="property">source</span>.<span class="title function_">shift</span>() || <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化</span></span><br><span class="line"><span class="keyword">let</span> myReadable = <span class="keyword">new</span> <span class="title class_">MyReadable</span>(source)</span><br><span class="line"></span><br><span class="line"><span class="comment">// readable 暂停模式  需要主动调用read</span></span><br><span class="line">myReadable.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// console.log(1) 这里会连续打印两次1</span></span><br><span class="line">  <span class="keyword">let</span> data = <span class="literal">null</span></span><br><span class="line">  <span class="comment">// 下面的打印结果跟readable 的触发时机有关，简单说就是readable被触发时，缓存区中已经有内容了</span></span><br><span class="line">  <span class="comment">// 读里面内容的时候 就会接着读</span></span><br><span class="line">  <span class="keyword">while</span> ((data = myReadable.<span class="title function_">read</span>()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">    <span class="comment">// 打印结果</span></span><br><span class="line">    <span class="comment">// lgzec</span></span><br><span class="line">    <span class="comment">// zyy</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">myReadable.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>())</span><br><span class="line">  <span class="comment">// 打印结果 需要注释上面readable的代码</span></span><br><span class="line">  <span class="comment">// lg</span></span><br><span class="line">  <span class="comment">// zec</span></span><br><span class="line">  <span class="comment">// zyy</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="可写流"><a href="#可写流" class="headerlink" title="可写流"></a>可写流</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的代码 其实就是实现一个复制的操作</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个可读流 生产数据</span></span><br><span class="line"><span class="keyword">let</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;a.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个可写流 消费数据</span></span><br><span class="line"><span class="keyword">let</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;c.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听事件调用方法完成具体的消费</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 执行数据写入</span></span><br><span class="line">  ws.<span class="title function_">write</span>(chunk)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>自定义可写流</strong></p>
<ul>
<li>继承 stream 模块的 Writeable</li>
<li>重写_write 方法，调用 write 执行写入</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/16/acRkD1Yf5SstJiZ.png" alt="image-20230616164729883"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWriteable</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_write</span>(<span class="params">chunk, en, done</span>) &#123;</span><br><span class="line">    process.<span class="property">stdout</span>.<span class="title function_">write</span>(chunk.<span class="title function_">toString</span>() + <span class="string">&#x27;&lt;--------&#x27;</span>)</span><br><span class="line">    <span class="comment">// 将回调函数放到tick中，保证同步代码执行完毕后，回调函数再执行</span></span><br><span class="line">    process.<span class="title function_">nextTick</span>(done)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myWriteable = <span class="keyword">new</span> <span class="title class_">MyWriteable</span>()</span><br><span class="line">myWriteable.<span class="title function_">write</span>(<span class="string">&#x27;blue sky&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 打印结果 blue sky&lt;--------end</span></span><br></pre></td></tr></table></figure>

<h4 id="Duplex-amp-amp-Transform"><a href="#Duplex-amp-amp-Transform" class="headerlink" title="Duplex &amp;&amp; Transform"></a>Duplex &amp;&amp; Transform</h4><blockquote>
<p>node 中的 stream 是流操作的抽象接口的集合，可读、可写、双工、转换 是单一抽象具体实现</p>
</blockquote>
<blockquote>
<p>Duplex 是一个同时实现了 Readable 和 Writeable 的流，既能生产又能消费。其中读和写是独立的，读操作生产的数据 不能 直接作为 写操作的数据源 来使用</p>
<p>Transform 也是一个双工流，读写操作连通</p>
</blockquote>
<p><strong>自定义双工流</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; <span class="title class_">Duplex</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDuplex</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Duplex</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">source</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">source</span> = source</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_read</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="variable language_">this</span>.<span class="property">source</span>.<span class="title function_">shift</span>() || <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(data)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_write</span>(<span class="params">chunk, en, next</span>) &#123;</span><br><span class="line">    process.<span class="property">stdout</span>.<span class="title function_">write</span>(chunk)</span><br><span class="line">    process.<span class="title function_">nextTick</span>(next)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">let</span> myDuplex = <span class="keyword">new</span> <span class="title class_">MyDuplex</span>(source)</span><br><span class="line"></span><br><span class="line">myDuplex.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">myDuplex.<span class="title function_">write</span>(<span class="string">&#x27;上海北京&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">111</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>自定义转换流</strong></p>
<ul>
<li>继承 Transform 类</li>
<li>重写_transform 方法，调用 Push 和 callback</li>
<li>重写_flush 方法，处理剩余数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; <span class="title class_">Transform</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTransform</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Transform</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_transform</span>(<span class="params">chunk, en, cb</span>) &#123;</span><br><span class="line">    <span class="comment">// 对数据进行处理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(chunk.<span class="title function_">toString</span>().<span class="title function_">toUpperCase</span>())</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> t = <span class="keyword">new</span> <span class="title class_">MyTransform</span>()</span><br><span class="line"></span><br><span class="line">t.<span class="title function_">write</span>(<span class="string">&#x27;abcs&#x27;</span>)</span><br><span class="line">t.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>()) <span class="comment">// ABCS</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="文件可读流"><a href="#文件可读流" class="headerlink" title="文件可读流"></a>文件可读流</h4><p><strong>1.文件可读流的创建和消费</strong></p>
<p><strong>fs.createReadStream 参数</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;data.txt&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 表示用什么方式来操作文件</span></span><br><span class="line">  <span class="attr">flags</span>: <span class="string">&#x27;r&#x27;</span>,</span><br><span class="line">  <span class="comment">// 用null,当前返回数据的类型就是buffer</span></span><br><span class="line">  <span class="attr">encoding</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 文件标识符</span></span><br><span class="line">  <span class="attr">fd</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 438表示十进制</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="number">438</span>,</span><br><span class="line">  <span class="comment">// 表示是否自动关闭文件</span></span><br><span class="line">  <span class="attr">autoClose</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">start</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="comment">// end: 3,</span></span><br><span class="line">  <span class="comment">// 表示每次读多少字节数据 文件可读流默认64  readable默认16</span></span><br><span class="line">  <span class="comment">// highWaterMark: 2,</span></span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">4</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>data 流动模式 可以切换为暂停</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>())</span><br><span class="line">  <span class="comment">// 打印结果</span></span><br><span class="line">  <span class="comment">// 12</span></span><br><span class="line">  <span class="comment">// 34</span></span><br><span class="line">  <span class="comment">// 在data中暂停和恢复</span></span><br><span class="line">  rs.<span class="title function_">pause</span>()</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    rs.<span class="title function_">resume</span>()</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>使用 readable 事件来读取数据</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// let data = rs.read()</span></span><br><span class="line">  <span class="comment">// console.log(data)</span></span><br><span class="line">  <span class="comment">// 打印结果</span></span><br><span class="line">  <span class="comment">// &lt;Buffer 31 32&gt;</span></span><br><span class="line">  <span class="comment">// &lt;Buffer 33 34&gt;</span></span><br><span class="line">  <span class="comment">// null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果想要看到字段输出 需要换一种方式</span></span><br><span class="line">  <span class="keyword">let</span> data</span><br><span class="line">  <span class="keyword">while</span> ((data = rs.<span class="title function_">read</span>()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">    <span class="comment">// 打印结果</span></span><br><span class="line">    <span class="comment">// 12</span></span><br><span class="line">    <span class="comment">// 34</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>理解 highWaterMark</strong></p>
<p>当 readable 被触发，缓存区内会存入 highWaterMark 个数据，然后 rs.read(1)消费指定数量的数据，如果缓存区内可以满足 rs.read(1)的数量，则直接消费；如果数量不够，就读入 highWaterMark 个数量的数据。（只在视频中 highWaterMark 改为 4 调用 read 时传入 1 时满足，当改成将 highWaterMark 改为 4 调用 read 时传入 5 时，不满足这样的规律。即只有 highWaterMark&gt;read 数量时满足）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将highWaterMark改为4 调用read时传入1</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;readable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> data</span><br><span class="line">  <span class="keyword">while</span> ((data = rs.<span class="title function_">read</span>(<span class="number">1</span>)) !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---&#x27;</span>, rs.<span class="property">_readableState</span>.<span class="property">length</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// a --- 3</span></span><br><span class="line"><span class="comment">// b --- 2</span></span><br><span class="line"><span class="comment">// c --- 1</span></span><br><span class="line"><span class="comment">// d --- 0</span></span><br><span class="line"><span class="comment">// e --- 2</span></span><br><span class="line"><span class="comment">// f --- 1</span></span><br><span class="line"><span class="comment">// g --- 0</span></span><br></pre></td></tr></table></figure>

<p><strong>2.文件可读流的事件与应用</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// open的执行时机：只要调用了createReadStream就会触发</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">(<span class="params">fd</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(fd, <span class="string">&#x27;文件打开了&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有数据被消费了之后才会触发</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件关闭了&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bufferArr = []</span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  bufferArr.<span class="title function_">push</span>(chunk)</span><br><span class="line">  <span class="comment">// console.log(chunk.toString())</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在close之前 所有数据都消费完毕</span></span><br><span class="line"><span class="comment">// 在data中  chunk的数据是Buffer，而且可能不连续</span></span><br><span class="line"><span class="comment">// 所以应该在end中使用数据</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">concat</span>(bufferArr).<span class="title function_">toString</span>())</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当数据被清空了&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;出错了&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="文件可写流"><a href="#文件可写流" class="headerlink" title="文件可写流"></a>文件可写流</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;test.txt&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">flags</span>: <span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="number">438</span>,</span><br><span class="line">  <span class="attr">fd</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">  <span class="attr">start</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">3</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：这里ok1  ok2 都是异步操作 但是执行顺序是固定的</span></span><br><span class="line"><span class="comment">// 注意：这里写入的需要是字符串或者Buffer(fs 中的 rs)</span></span><br><span class="line">ws.<span class="title function_">write</span>(<span class="string">&#x27;凤凰稻城&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">write</span>(<span class="string">&#x27;或是巴黎&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok2&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>文件可写流的事件</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.createWriteStream就会触发</span></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">(<span class="params">fd</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;open&#x27;</span>, fd)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// close 是在数据写入全部完成之后执行</span></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;close&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接ws.write(1) 是语法错误 不会触发error</span></span><br><span class="line"><span class="comment">// 在end之后 ws.write 会触发error</span></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行这个方法，表示写操作已经完成了</span></span><br><span class="line"><span class="comment">// 不传参数的话，表示把缓存区的内容清空</span></span><br><span class="line"><span class="comment">// 传参的话 会最后写入</span></span><br><span class="line">ws.<span class="title function_">end</span>(<span class="string">&#x27;我们终究会牵手旅行&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="write-执行流程"><a href="#write-执行流程" class="headerlink" title="write 执行流程"></a>write 执行流程</h4><blockquote>
<p>视频 42 读源码 没仔细看</p>
</blockquote>
<p><strong>write 返回值的作用</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;test.txt&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">3</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flag = ws.<span class="title function_">write</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(flag)</span><br><span class="line"></span><br><span class="line">flag = ws.<span class="title function_">write</span>(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(flag)</span><br><span class="line"></span><br><span class="line">flag = ws.<span class="title function_">write</span>(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面这段代码的打印结果</span></span><br><span class="line"><span class="comment">// true</span></span><br><span class="line"><span class="comment">// true</span></span><br><span class="line"><span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 此时查看test.txt&#x27;  123正常都写入了</span></span><br><span class="line"><span class="comment">// 结论：flag为false， 并不是说明当前数据不能被执行写入</span></span><br><span class="line"><span class="comment">// 说明：实际上flag控制的是上游数据的产量</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>1.第一次调用 write 方法时是将数据直接写入到文件中</p>
<p>2.第二次开始 write 方法就是将数据写入至缓存中</p>
<p>3.生产速度 和 消费速度是不一样的，一般情况下生产速度要比消费速度快很多</p>
<p>4.当 flag 为 false 之后并不意味着当前次的数据不能被写入了。但是我们应该告之数据的生产者，当前的消费速度已经跟不上生产速度了，所以这个时候，一般我们会将可读流的模块修改为暂停模式。</p>
<p>5.当数据生产者暂停之后，消费者会慢慢的消化它内部缓存中的数据，直到可以再次被执行写入操作</p>
<p>6.当缓冲区可以继续写入数据时如何让生产者知道？drain 事件</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/19/HX3YWZSVwJkTLx2.png" alt="image-20230619165754114"></p>
<p>通过阅读源码：</p>
<p>如果当前写入量大于等于 highWaterMark，flag 的值就会变成 false。</p>
<p>当 flag 为 false 时，并不意味着不再写入，而是将数据缓存起来，留着去写。</p>
<p>通知生产者，消费的速度跟不上，应该把生产数据动作停掉。</p>
<p>缓存内的数据被写完时，同时 flag 为 false 时，就会触发 drain 事件</p>
<h4 id="drain-与写入速度"><a href="#drain-与写入速度" class="headerlink" title="drain 与写入速度"></a>drain 与写入速度</h4><blockquote>
<p>在实际应用中，drain 事件也不是特别常用。因为有更好的 pipe 方法来处理数据。</p>
</blockquote>
<p><strong>梳理 drain 和 pipe</strong></p>
<p>drain 相当于交警，pipe 相当于红路灯系统。当红路灯正常时，不需要交警指挥。</p>
<p>drain 主要用于控制速度，或者按需来限流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;text.txt&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">3</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ws.write(&#x27;一眼顶针&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source = <span class="string">&#x27;一眼顶针&#x27;</span>.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">executeWrite</span>(<span class="params"></span>) &#123;</span><br><span class="line">  flag = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">while</span> (num !== <span class="number">4</span> &amp;&amp; flag) &#123;</span><br><span class="line">    flag = ws.<span class="title function_">write</span>(source[num])</span><br><span class="line">    num++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">executeWrite</span>()</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;drain&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;drain 执行了&#x27;</span>, num, flag)</span><br><span class="line">  <span class="title function_">executeWrite</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// drain 执行了 1 false</span></span><br><span class="line"><span class="comment">// drain 执行了 2 false</span></span><br><span class="line"><span class="comment">// drain 执行了 3 false</span></span><br><span class="line"><span class="comment">// drain 执行了 4 false</span></span><br></pre></td></tr></table></figure>

<h4 id="背压机制"><a href="#背压机制" class="headerlink" title="背压机制"></a>背压机制</h4><blockquote>
<p>具体在使用层面上就是 pipe 方法</p>
<p>node.js 的 stream 已经实现了背压机制</p>
<p>我们要看的是 nodejs 中的数据读写的过程 以及 背压机制解决了什么样的问题</p>
<p>还有 pipe 方法内部实现的原理大概是什么样的</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存在的问题：数据被读取的速度远远大于数据被写入的数据</span></span><br><span class="line"><span class="comment">// writeable的内部维护着一个队列，当它不能消费上游传递的数据时，它就会尝试将这些不能被消化的数据缓存到队列里，但是队列容量有限，可能导致：</span></span><br><span class="line"><span class="comment">// 内存溢出、GC频繁调用、其他进程变慢</span></span><br><span class="line"><span class="comment">// 需要有一种在数据的生产者和消费者之间平滑流动的机制，这就是所谓的背压机制</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;a.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;b.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123;</span><br><span class="line">  ws.<span class="title function_">write</span>(chunk)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图中将读取流程分为三部分：底层数据、缓存（默认在 readable 中是 16kb，在文件可读流中是 64kb）、数据的消费者（通过主动的调用 read 方法，或者监听 data 事件来消费数据）</p>
<p>除此之外，可读流还有两种工作模式：一种是流动模式，一种是暂停模式（默认）</p>
<p><img src="https://s2.loli.net/2023/06/21/yvEwTUc8GxSJngz.png" alt="image-20230621171612137"></p>
<p>数据的写操作：数据从上游的生产者传递过来，然后可写流去调用 write 方法，在可写流的内部同样存在一片内存空间来充当缓存的队列。当上游传递过来的数据超过水位线，write 方法就会返回 false，告诉生产者暂停放水。当可写流将缓存中的数据消费的差不多了之后，触发 drain 事件，告诉生产者继续放水，这时就可以调用 resume 方法再次打开阀门。如此往复，就能保证数据的平滑流动。</p>
<p>既不会出现内存被撑爆的情况，也不会无水可用</p>
<p><img src="https://s2.loli.net/2023/06/21/ZBy4TsEJvNF9VtA.png" alt="image-20230621172104531"></p>
<p><strong>下面的过程就是 pipe 方法的原理 实际上我们一般不会手写下面的代码</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;test.txt&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">4</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;test1.txt&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">1</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  flag = ws.<span class="title function_">write</span>(chunk, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写完了&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">    rs.<span class="title function_">pause</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;drain&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  rs.<span class="title function_">resume</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>上面的代码可以直接用 pipe 实现</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.<span class="title function_">pipe</span>(ws)</span><br></pre></td></tr></table></figure>

<p>45&#x2F;46&#x2F;47 模拟实现没看</p>
<p>链表结构</p>
<blockquote>
<p>可以将它理解为一种存储数据的结构，在文件可写流工作的时候，有些被写入的内容需要在缓冲区中排队等待，而且遵循先进先出的规则。在新版的 node 中使用链表来存储这些数据。</p>
</blockquote>
<p><strong>为什么不采用数组存储数据？</strong></p>
<ul>
<li>数组存储的长度具有上限</li>
<li>数组存在塌陷问题（执行插入或删除操作的时候，都会移动其他元素的位置）</li>
<li>在 js 中数组被实现 成一个对象，使用效率上会低一些</li>
</ul>
<p>链表概念</p>
<blockquote>
<p>链表是一系列节点的集合（这里的节点约定为 node 节点），每个节点都具有指向下一个节点的属性</p>
<p>链表分类： 双向链表、单向链表、循环链表</p>
</blockquote>
<p>50&#x2F;51&#x2F;52 单向链表的实现 没看</p>
<p>53&#x2F;54&#x2F;55 文件可写流实现 没看</p>
<p>56 pipe 方法实现 没看</p>
<h3 id="Events-概念"><a href="#Events-概念" class="headerlink" title="Events(概念)"></a>Events(概念)</h3><blockquote>
<p>在实际使用中一般不会单独引入 Events</p>
<p>因为 node 本身就是基于事件驱动来实现的异步操作，而事件驱动的底层的表现就是 EventEmitter 类，很多的模块本身就继承了这个类，这就以为着他们本身就具备了事件注册和发布的能力</p>
</blockquote>
<h4 id="EventEmitter-常见-api"><a href="#EventEmitter-常见-api" class="headerlink" title="EventEmitter 常见 api"></a>EventEmitter 常见 api</h4><p><img src="https://s2.loli.net/2023/06/15/42ArTzPCUS51u6J.png" alt="image-20230615154210114"></p>
<h4 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h4><p>27 28 29 发布订阅 模拟 event 类 没看</p>
<blockquote>
<p>定义了对象间一对多的依赖关系</p>
<p>EventEmitter 类是基于发布订阅实现的</p>
</blockquote>
<blockquote>
<p>工作流程：订阅者将自己想订阅的事件监听先去注册到调度中心，等到事件被触发时，发布者就会把事件发布到调度中心，之后由调度中心统一去调用订阅者注册的处理代码</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/15/3Fwtgf1CIRinA7c.png" alt="image-20230615154635254"></p>
<p><strong>发布订阅要素</strong></p>
<ul>
<li>缓存队列，存放订阅者信息</li>
<li>具有增减、删除订阅的能力</li>
<li>状态改变时通知所有订阅者执行监听</li>
</ul>
<p><strong>发布订阅和观察者模式的区别</strong></p>
<p>发布订阅有调度中心，观察者没有</p>
<p>状态发生改变时，发布订阅无须主动通知</p>
<h2 id="事件循环-概念"><a href="#事件循环-概念" class="headerlink" title="事件循环(概念)"></a>事件循环(概念)</h2><h3 id="浏览器中的事件循环"><a href="#浏览器中的事件循环" class="headerlink" title="浏览器中的事件循环"></a>浏览器中的事件循环</h3><blockquote>
<p>每次执行完一个宏任务都会清空一次微任务</p>
<p>注意：这里的 s1 s2 指的是定时器本身，不是内部的 console.log(‘s1’)</p>
<p>注意：队列中的任务先进先出</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/15/naPlyrpRgBjFCWh.png" alt="image-20230615161209402"></p>
<p><img src="https://s2.loli.net/2023/06/15/wSCeLq8mHcRyKnh.png" alt="image-20230615161508119"></p>
<p><img src="https://s2.loli.net/2023/06/15/pIoXkRGueBHTFlO.png" alt="image-20230615164721173"></p>
<h3 id="node-中的事件循环"><a href="#node-中的事件循环" class="headerlink" title="node 中的事件循环"></a>node 中的事件循环</h3><blockquote>
<p>浏览器中有 2 个事件队列 node 中有 6 个事件队列</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/15/71qCORxXJlM369j.png" alt="image-20230615165017685"></p>
<p><img src="https://s2.loli.net/2023/06/15/vP1isqBD2hnOGeS.png" alt="image-20230615165409850"></p>
<blockquote>
<p>下图说明</p>
<p>1.首先执行同步代码，完成后去查看微任务 是否有满足条件的回调，如果有就会执行（nextTick 优先于 promise.then()）</p>
<p>2.所有的微任务列表清空以后，将队列切到 timer,timer 完全执行完成以后，就会切换队列</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/15/rvlSTiotW5dCGRY.png" alt="image-20230615170049453"></p>
<p><img src="https://s2.loli.net/2023/06/15/q8Gz9iRfnHapPQS.png" alt="image-20230615172849013"></p>
<h3 id="两种事件循环区别"><a href="#两种事件循环区别" class="headerlink" title="两种事件循环区别"></a>两种事件循环区别</h3><ul>
<li><p>任务队列数不同</p>
<blockquote>
<p>浏览器 2 node6</p>
</blockquote>
</li>
<li><p>node 微任务执行时机不同</p>
<blockquote>
<p>1.两个都会在同步代码执行完毕后执行微任务</p>
<p>2.浏览器平台下每当一个宏任务执行完毕后就清空微任务</p>
<p>node 中在事件队列切换时回去清空微任务</p>
</blockquote>
</li>
<li><p>微任务优先级不同</p>
<blockquote>
<p>浏览器事件循环中，微任务存放于事件队列，先进先出</p>
<p>node 中 process.nextTick 优先于 promise.then</p>
</blockquote>
</li>
</ul>
<h3 id="node-事件循环常见问题"><a href="#node-事件循环常见问题" class="headerlink" title="node 事件循环常见问题"></a>node 事件循环常见问题</h3><blockquote>
<p>同样的代码，有时先执行 setTimeout 有时先执行 immediate</p>
<p>因为 setTimeout 默认是 0，有时会出现延时</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/16/esam2DwqVrXvjRB.png" alt="image-20230616103850094"></p>
<blockquote>
<p>如果将上面两者放到 readFile 的回调函数中，readFile 被放在 poll 队列中，poll 中完成后要进行队列切换，就到了 check 队列，执行完毕后再沿着事件环回到 timer</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/16/MehK1X4LDmP9R6s.png" alt="image-20230616135447011"></p>
<h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><p>22 源码没看 23vm 模块 24 25 模拟实现模块加载 这几节都没看</p>
<h3 id="CommonJS-概念"><a href="#CommonJS-概念" class="headerlink" title="CommonJS(概念)"></a>CommonJS(概念)</h3><p><img src="https://s2.loli.net/2023/06/14/WyBKi4VpFRxEfmw.png" alt="image-20230614164444181"></p>
<h3 id="module-属性"><a href="#module-属性" class="headerlink" title="module 属性"></a>module 属性</h3><p><img src="https://s2.loli.net/2023/06/14/ksaSJBTb5K2Ut6R.png" alt="image-20230614163703375"></p>
<p><strong>module.exports 和 exports 有什么区别？</strong></p>
<blockquote>
<p>在 commonjs 中只规定了通过 module.exports 来执行导出操作，exports 本身是 node 自己为了方便操作，而给每个模块提供了一个变量，指向了 module.exports 所对应的内存地址。因此可以通过 exports 导出响应的内容。</p>
<p>但是不能直接给 exports 赋值，因为这样切断了 exports 和 modules.exports 之间的联系。</p>
<p>可以使用 exports.name &#x3D; ‘tom’ 但是不可以 exports &#x3D; {}</p>
</blockquote>
<h3 id="require-属性"><a href="#require-属性" class="headerlink" title="require 属性"></a>require 属性</h3><blockquote>
<p>基本功能是读入并且执行一个模块文件，然后返回这个文件的 exports 对象</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/GzMInYjqcTe1D3V.png" alt="image-20230614164308033"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.模块的导入导出</span></span><br><span class="line"><span class="comment">// m.js</span></span><br><span class="line"><span class="keyword">const</span> age = <span class="number">18</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">addFn</span> = (<span class="params">x, y</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">age</span>: age,</span><br><span class="line">  <span class="attr">addFn</span>: addFn,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;m.js&#x27;</span>, <span class="built_in">require</span>.<span class="property">main</span> === <span class="variable language_">module</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主文件1.js</span></span><br><span class="line"><span class="keyword">let</span> obj = <span class="built_in">require</span>(<span class="string">&#x27;./m&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1.js&#x27;</span>, <span class="built_in">require</span>.<span class="property">main</span> === <span class="variable language_">module</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line">m.<span class="property">js</span> <span class="literal">false</span></span><br><span class="line"><span class="number">1.</span>js <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="模块加载"><a href="#模块加载" class="headerlink" title="模块加载"></a>模块加载</h3><p><strong>1.模块分类</strong></p>
<p>内置模块 &#x2F; 文件模块</p>
<p><strong>2.模块加载速度</strong></p>
<ul>
<li>核心模块：Node 代码编译时写入到二进制文件中</li>
<li>文件模块：代码运行时，动态加载</li>
</ul>
<p><strong>3.加载流程</strong></p>
<blockquote>
<p>路径分析–&gt;文件定位–&gt;编译执行</p>
</blockquote>
<ul>
<li><p>路径分析：依据标识符确定模块位置</p>
<blockquote>
<p>标识符分为路径、非路径两种，非路径见于核心模块（如 fs http path 直接写名字就可以了）。对于自定义包或者第三方包也可以直接写名字</p>
<p>node 查找模块的策略：</p>
<p>查找 node_modules 目录，从当前文件的父级开始，直到当前项目的盘符下</p>
<p><img src="https://s2.loli.net/2023/06/15/DVE6rCmcun8xla7.png" alt="image-20230615150300358"></p>
</blockquote>
</li>
<li><p>文件定位：确定目标模块中具体的文件及文件类型</p>
<blockquote>
<p>1.项目下存在 m1.js 模块，导入时使用 require(‘m1’)</p>
<p>2.当 require 不加扩展名时，node 按照.js .json .node 补足扩展名</p>
<p>3.如果都没找到，node 认为拿到的是一个目录。查找 package.json，使用 JSON.parse()解析，从而取出描述文件中的 main 属性值</p>
<p>4.如果 main 属性值没有扩展名，尝试补全 main.js-&gt;main.json-&gt;main.node</p>
<p>5.如果 main 补足后还是没有或者就没有 package.json 文件，node 就将 index 作为目标模块中的具体文件名称</p>
</blockquote>
</li>
<li><p>编译执行：采用对应的方式完成文件的编译执行</p>
</li>
<li><blockquote>
<p>JS 文件的编译执行</p>
<p>1.使用 fs 模块同步读入目标文件内容</p>
<p>2.对内容进行语法包装，生成可执行的 JS 函数</p>
<p>3.调用函数时传入 exports、module、require 等属性值</p>
</blockquote>
<blockquote>
<p>JSON 文件编译执行</p>
<p>将读取到的内容通过 JSON.parse()进行解析，然后将结果返回给 exports 对象</p>
</blockquote>
</li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a><a class="post-meta__tags" href="/tags/node/">node</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/06/21/vrZHaQkuVwFMXJq.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/404.jpg" target="_blank"><img class="post-qr-code-img" src="/img/404.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/404.jpg" target="_blank"><img class="post-qr-code-img" src="/img/404.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/25/%E5%89%8D%E7%AB%AF/node/2.express/" title="Node2-Express"><img class="cover" src="https://s2.loli.net/2023/06/21/sEudraT748pXt2l.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Node2-Express</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/11/%E6%A0%87%E7%AD%BE%E5%A4%96%E6%8C%82%E7%94%A8%E6%B3%95Demo/" title="hexo标签外挂用法"><img class="cover" src="https://s2.loli.net/2023/06/21/mB7kAVdjTgx1t2Y.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">hexo标签外挂用法</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/05/25/%E5%89%8D%E7%AB%AF/node/2.express/" title="Node2-Express"><img class="cover" src="https://s2.loli.net/2023/06/21/sEudraT748pXt2l.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-25</div><div class="title">Node2-Express</div></div></a></div><div><a href="/2023/05/31/%E5%89%8D%E7%AB%AF/node/3.Koa/" title="Node3-Koa2"><img class="cover" src="https://s2.loli.net/2023/06/21/lZNgKaus1kMJEpW.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-31</div><div class="title">Node3-Koa2</div></div></a></div><div><a href="/2023/05/29/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%BB%BC%E5%90%88%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B9%8B%E9%80%9A%E7%94%A8%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/" title="test-new"><img class="cover" src="https://drfs.ctcontents.com/file/17768331/857608992/3ef618/224422-160087226277ed.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-29</div><div class="title">test-new</div></div></a></div><div><a href="/2023/06/19/%E5%89%8D%E7%AB%AF/ts/ts%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B/" title="ts复杂类型-占位1"><img class="cover" src="https://drfs.ctcontents.com/file/17768331/857608992/3ef618/224422-160087226277ed.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-19</div><div class="title">ts复杂类型-占位1</div></div></a></div><div><a href="/2023/06/02/%E5%89%8D%E7%AB%AF/ts/1.%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" title="TS1-基本使用"><img class="cover" src="https://s2.loli.net/2023/06/21/sEudraT748pXt2l.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-02</div><div class="title">TS1-基本使用</div></div></a></div><div><a href="/2023/06/10/%E5%89%8D%E7%AB%AF/ts/2.%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%B3%9B%E5%9E%8B%E8%BF%90%E7%AE%97/" title="TS2-泛型和泛型运算"><img class="cover" src="https://s2.loli.net/2023/06/21/mB7kAVdjTgx1t2Y.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-10</div><div class="title">TS2-泛型和泛型运算</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic3.zhimg.com/80/v2-a32e894df08df50d7a3674b64fec74f2_1440w.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">John Doe</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xxxxx" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xxxxxx#gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#node-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">node 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.1.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-IO-%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">Node IO 过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">Node 事件驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nodejs-%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.4.</span> <span class="toc-text">Nodejs 单线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nodejs-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.5.</span> <span class="toc-text">Nodejs 常见的应用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">1.2.</span> <span class="toc-text">全局变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#process"><span class="toc-number">1.2.1.</span> <span class="toc-text">process</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">获取信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">事件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.</span> <span class="toc-text">核心模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#path"><span class="toc-number">1.3.1.</span> <span class="toc-text">path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer"><span class="toc-number">1.3.2.</span> <span class="toc-text">Buffer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Buffer-%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">创建 Buffer 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Buffer-%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Buffer 实例方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Buffer-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">Buffer 静态方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fs"><span class="toc-number">1.3.3.</span> <span class="toc-text">fs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fs-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">fs 基本知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C-API"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">文件操作 API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E5%A4%8D%E5%88%B6"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">大文件读写复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">目录操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream"><span class="toc-number">1.3.4.</span> <span class="toc-text">Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%AF%BB%E6%B5%81"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">可读流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E5%86%99%E6%B5%81"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">可写流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Duplex-amp-amp-Transform"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">Duplex &amp;&amp; Transform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8F%AF%E8%AF%BB%E6%B5%81"><span class="toc-number">1.3.4.5.</span> <span class="toc-text">文件可读流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8F%AF%E5%86%99%E6%B5%81"><span class="toc-number">1.3.4.6.</span> <span class="toc-text">文件可写流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#write-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.4.7.</span> <span class="toc-text">write 执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#drain-%E4%B8%8E%E5%86%99%E5%85%A5%E9%80%9F%E5%BA%A6"><span class="toc-number">1.3.4.8.</span> <span class="toc-text">drain 与写入速度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%8C%E5%8E%8B%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.4.9.</span> <span class="toc-text">背压机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Events-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.5.</span> <span class="toc-text">Events(概念)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EventEmitter-%E5%B8%B8%E8%A7%81-api"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">EventEmitter 常见 api</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">发布订阅模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.4.</span> <span class="toc-text">事件循环(概念)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">浏览器中的事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.4.2.</span> <span class="toc-text">node 中的事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%8C%BA%E5%88%AB"><span class="toc-number">1.4.3.</span> <span class="toc-text">两种事件循环区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.4.</span> <span class="toc-text">node 事件循环常见问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">模块化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonJS-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.1.</span> <span class="toc-text">CommonJS(概念)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#module-%E5%B1%9E%E6%80%A7"><span class="toc-number">1.5.2.</span> <span class="toc-text">module 属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#require-%E5%B1%9E%E6%80%A7"><span class="toc-number">1.5.3.</span> <span class="toc-text">require 属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.5.4.</span> <span class="toc-text">模块加载</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/07/21/%E5%89%8D%E7%AB%AF/vue/vue3%E6%96%87%E6%A1%A3-2%E6%B7%B1%E5%85%A5%E7%BB%84%E4%BB%B6/" title="Vue3 文档 2-深入组件"><img src="https://s2.loli.net/2023/06/21/C3AUYLteNiz8E7W.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue3 文档 2-深入组件"/></a><div class="content"><a class="title" href="/2023/07/21/%E5%89%8D%E7%AB%AF/vue/vue3%E6%96%87%E6%A1%A3-2%E6%B7%B1%E5%85%A5%E7%BB%84%E4%BB%B6/" title="Vue3 文档 2-深入组件">Vue3 文档 2-深入组件</a><time datetime="2023-07-21T05:52:42.000Z" title="Created 2023-07-21 13:52:42">2023-07-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/13/%E5%89%8D%E7%AB%AF/vue/vue3%E6%96%87%E6%A1%A3%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86/" title="Vue3 文档 1-基础"><img src="https://s2.loli.net/2023/06/21/sEudraT748pXt2l.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue3 文档 1-基础"/></a><div class="content"><a class="title" href="/2023/07/13/%E5%89%8D%E7%AB%AF/vue/vue3%E6%96%87%E6%A1%A3%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86/" title="Vue3 文档 1-基础">Vue3 文档 1-基础</a><time datetime="2023-07-13T09:26:37.000Z" title="Created 2023-07-13 17:26:37">2023-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/19/%E5%89%8D%E7%AB%AF/ts/ts%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B/" title="ts复杂类型-占位1"><img src="https://drfs.ctcontents.com/file/17768331/857608992/3ef618/224422-160087226277ed.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ts复杂类型-占位1"/></a><div class="content"><a class="title" href="/2023/06/19/%E5%89%8D%E7%AB%AF/ts/ts%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B/" title="ts复杂类型-占位1">ts复杂类型-占位1</a><time datetime="2023-06-19T07:40:38.000Z" title="Created 2023-06-19 15:40:38">2023-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/10/%E5%89%8D%E7%AB%AF/ts/2.%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%B3%9B%E5%9E%8B%E8%BF%90%E7%AE%97/" title="TS2-泛型和泛型运算"><img src="https://s2.loli.net/2023/06/21/mB7kAVdjTgx1t2Y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TS2-泛型和泛型运算"/></a><div class="content"><a class="title" href="/2023/06/10/%E5%89%8D%E7%AB%AF/ts/2.%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%B3%9B%E5%9E%8B%E8%BF%90%E7%AE%97/" title="TS2-泛型和泛型运算">TS2-泛型和泛型运算</a><time datetime="2023-06-10T11:22:12.000Z" title="Created 2023-06-10 19:22:12">2023-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/02/%E5%89%8D%E7%AB%AF/ts/1.%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" title="TS1-基本使用"><img src="https://s2.loli.net/2023/06/21/sEudraT748pXt2l.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TS1-基本使用"/></a><div class="content"><a class="title" href="/2023/06/02/%E5%89%8D%E7%AB%AF/ts/1.%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" title="TS1-基本使用">TS1-基本使用</a><time datetime="2023-06-02T12:05:09.000Z" title="Created 2023-06-02 20:05:09">2023-06-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>